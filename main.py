# main.py (versi√≥n reorganizada)

import json
import streamlit as st
import pandas as pd
from utils import cargar_cursos, cursos_validos, validar_manual
from simulador import simular_avance
from utils import construir_grafo, mostrar_grafo_pyvis, alertas_riesgo, predecir_graduacion

# Configuraci√≥n de la p√°gina
st.set_page_config(
    page_title="Planificador Acad√©mico Inteligente",
    layout="wide",
    page_icon="üéì",
    initial_sidebar_state="expanded"
)

# Estilos CSS personalizados (igual que antes)
st.markdown("""
    <style>
        :root {
            --primary: #2E86AB;
            --secondary: #F18F01;
            --success: #4CAF50;
            --warning: #FFC107;
            --danger: #F44336;
        }
        .main {
            max-width: 1400px;
            padding: 2rem;
        }
        .header {
            color: var(--primary);
            border-bottom: 2px solid var(--secondary);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .subheader {
            color: var(--primary);
            margin-top: 1.5rem;
        }
        .card {
            background-color: #FFFFFF;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .stButton>button {
            background-color: var(--primary);
            color: white;
            border-radius: 5px;
            padding: 8px 16px;
            margin: 5px 0;
            transition: all 0.3s;
        }
        .stButton>button:hover {
            background-color: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .stSelectbox, .stSlider, .stMultiselect {
            margin-bottom: 1rem;
        }
        .sidebar .sidebar-content {
            background-color: #f8f9fa;
        }
        .progress-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin: 10px 0;
        }
        .progress-bar {
            height: 20px;
            border-radius: 5px;
            background-color: var(--primary);
            text-align: center;
            line-height: 20px;
            color: white;
        }
        .course-card {
            border-left: 4px solid var(--primary);
            padding: 10px;
            margin: 5px 0;
            background-color: #f5f5f5;
            border-radius: 0 5px 5px 0;
        }
        .course-card.approved {
            border-left-color: var(--success);
            background-color: #e8f5e9;
        }
        .course-card.pending {
            border-left-color: var(--warning);
            background-color: #fff8e1;
        }
        .tab-content {
            padding: 15px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
    </style>
""", unsafe_allow_html=True)

# Cargar datos
@st.cache_data
def load_data():
    cursos = cargar_cursos()
    nombres_por_codigo = {c["codigo"]: c["nombre"] for c in cursos}
    
    # Agregar semestre basado en ciclo (1 o 2)
    for c in cursos:
        c["semestre"] = [c["ciclo"]]
    
    return cursos, nombres_por_codigo

cursos, nombres_por_codigo = load_data()

# Agrupar cursos por a√±o y ciclo
cursos_por_anio_ciclo = {}
for c in cursos:
    anio, ciclo = c["anio"], c["ciclo"]
    cursos_por_anio_ciclo.setdefault(anio, {}).setdefault(ciclo, []).append(c)

# P√°ginas principales
pagina = st.sidebar.radio("Navegaci√≥n", ["üìã Mi Progreso y Planificaci√≥n", "üìä Visualizaciones"])

if pagina == "üìã Mi Progreso y Planificaci√≥n":
    # === P√ÅGINA DE PROGRESO Y PLANIFICACI√ìN ===
    st.markdown('<div class="header"><h1>üéì Mi Progreso y Planificaci√≥n</h1></div>', unsafe_allow_html=True)
    
    # === SELECCI√ìN DE CURSOS APROBADOS ===
    st.markdown('<div class="subheader"><h2>‚úÖ Selecci√≥n de Cursos Aprobados</h2></div>', unsafe_allow_html=True)
    
    with st.expander("‚ÑπÔ∏è Instrucciones", expanded=False):
        st.info("""
        Selecciona los cursos que ya has aprobado organizados por a√±o y ciclo acad√©mico.
        - Usa los botones **Seleccionar todos** para marcar todos los cursos de un ciclo
        - Puedes buscar cursos espec√≠ficos usando el filtro de b√∫squeda
        """)
    
    aprobados_codigos = []
    
    if "seleccion_por_ciclo" not in st.session_state:
        st.session_state["seleccion_por_ciclo"] = {}
    
    for anio in sorted(cursos_por_anio_ciclo):
        with st.expander(f"üìÖ A√±o {anio}", expanded=True):
            cols = st.columns(2)
            for i, ciclo in enumerate(sorted(cursos_por_anio_ciclo[anio])):
                with cols[i % 2]:
                    lista = cursos_por_anio_ciclo[anio][ciclo]
                    nombres = [c["nombre"] for c in lista]
                    
                    key_select_all = f"select_all_{anio}_{ciclo}"
                    key_multi = f"aprobado_{anio}_{ciclo}"
                    
                    # Inicializar almacenamiento en sesi√≥n
                    if key_select_all not in st.session_state["seleccion_por_ciclo"]:
                        st.session_state["seleccion_por_ciclo"][key_select_all] = False
                    
                    # Bot√≥n para seleccionar todos
                    if st.button(f"üìå Seleccionar todos - A√±o {anio} Ciclo {ciclo}", key=f"btn_{anio}_{ciclo}"):
                        st.session_state["seleccion_por_ciclo"][key_select_all] = not st.session_state["seleccion_por_ciclo"][key_select_all]
                    
                    # Definir valor por defecto en el multiselect
                    default_val = nombres if st.session_state["seleccion_por_ciclo"][key_select_all] else []
                    seleccionados = st.multiselect(
                        f"**Ciclo {ciclo} - A√±o {anio}**",
                        nombres,
                        default=default_val,
                        key=key_multi,
                        help=f"Selecciona los cursos aprobados del ciclo {ciclo} del a√±o {anio}"
                    )
                    
                    # Resetear selecci√≥n si el usuario borra manualmente
                    if len(seleccionados) == 0:
                        st.session_state["seleccion_por_ciclo"][key_select_all] = False
                    
                    for nombre in seleccionados:
                        for c in lista:
                            if c["nombre"] == nombre:
                                aprobados_codigos.append(c["codigo"])

    # === FILTROS ===
    st.markdown('<div class="subheader"><h2>üîç Filtros</h2></div>', unsafe_allow_html=True)
    col1, col2 = st.columns(2)
    with col1:
        mostrar_aprobados = st.checkbox("Mostrar solo cursos aprobados", False)
    with col2:
        mostrar_pendientes = st.checkbox("Mostrar solo cursos pendientes", False)
    
    # === RESUMEN DE PROGRESO ===
    st.markdown('<div class="subheader"><h2>üìä Resumen de Progreso Acad√©mico</h2></div>', unsafe_allow_html=True)
    
    if aprobados_codigos:
        # Calcular estad√≠sticas generales
        total_cursos = len(cursos)
        cursos_aprobados = len(aprobados_codigos)
        porcentaje_avance = (cursos_aprobados / total_cursos) * 100
        
        # Mostrar barra de progreso
        st.markdown(f"""
        <div class="progress-container">
            <div class="progress-bar" style="width: {porcentaje_avance}%">
                {porcentaje_avance:.1f}% completado
            </div>
        </div>
        """, unsafe_allow_html=True)
        
        # Mostrar m√©tricas
        col1, col2, col3 = st.columns(3)
        with col1:
            st.metric("Total cursos aprobados", cursos_aprobados)
        with col2:
            st.metric("Total cursos pendientes", total_cursos - cursos_aprobados)
        with col3:
            st.metric("Porcentaje completado", f"{porcentaje_avance:.1f}%")
        
        # Mostrar tabla detallada
        datos_aprobados = []
        for c in cursos:
            if c["codigo"] in aprobados_codigos:
                datos_aprobados.append({
                    "A√±o": c["anio"],
                    "Ciclo": c["ciclo"],
                    "C√≥digo": c["codigo"],
                    "Nombre": c["nombre"],
                    "Cr√©ditos": c.get("creditos", 0),
                    "Estado": "‚úÖ Aprobado"
                })
            else:
                datos_aprobados.append({
                    "A√±o": c["anio"],
                    "Ciclo": c["ciclo"],
                    "C√≥digo": c["codigo"],
                    "Nombre": c["nombre"],
                    "Cr√©ditos": c.get("creditos", 0),
                    "Estado": "‚åõ Pendiente"
                })
        
        df_progreso = pd.DataFrame(datos_aprobados)
        
        # Aplicar filtros
        if mostrar_aprobados:
            df_progreso = df_progreso[df_progreso["Estado"] == "‚úÖ Aprobado"]
        if mostrar_pendientes:
            df_progreso = df_progreso[df_progreso["Estado"] == "‚åõ Pendiente"]
        
        st.dataframe(
            df_progreso.sort_values(by=["A√±o", "Ciclo", "Nombre"]),
            use_container_width=True,
            hide_index=True,
            column_config={
                "Estado": st.column_config.SelectboxColumn(
                    "Estado",
                    options=["‚úÖ Aprobado", "‚åõ Pendiente"]
                )
            }
        )
    else:
        st.warning("No has seleccionado ning√∫n curso aprobado a√∫n.")
    
    # === CONFIGURACI√ìN ===
    st.markdown('<div class="subheader"><h2>‚öôÔ∏è Configuraci√≥n</h2></div>', unsafe_allow_html=True)
    col1, col2 = st.columns(2)
    with col1:
        ciclo_actual = st.selectbox(
            "Ciclo acad√©mico pr√≥ximo", 
            [1, 2], 
            help="Selecciona el ciclo que vas a cursar"
        )
    with col2:
        max_cursos = st.slider(
            "Cursos por ciclo", 
            1, 6, 3,
            help="N√∫mero m√°ximo de cursos que planeas llevar por ciclo"
        )
    
    
    st.markdown('<div class="subheader"><h2>üìÖ </h2></div>', unsafe_allow_html=True)
    
    codigos_aprobados = set(aprobados_codigos)
    nombres_pendientes = [c["nombre"] for c in cursos if c["codigo"] not in codigos_aprobados]
    
    # === RECOMENDACI√ìN INTELIGENTE ===
    st.markdown('<div class="subheader"><h2>ü§ñ Recomendaci√≥n Inteligente</h2></div>', unsafe_allow_html=True)
    
    modo_recomendacion = st.radio(
        "**Modo de recomendaci√≥n:**",
        ["Solo pr√≥ximo ciclo", "Simular varios ciclos", "Validaci√≥n manual", "üß† Recomendaci√≥n por IA (CSP)"],
        horizontal=True,
        help="Elige c√≥mo deseas que el sistema te ayude a planificar"
    )
    
    if st.button("üéØ Generar Recomendaci√≥n", use_container_width=True, key="btn_recomendar"):
        aprobados_nombres = [nombres_por_codigo[c] for c in aprobados_codigos if c in nombres_por_codigo]
        
        if modo_recomendacion == "Solo pr√≥ximo ciclo":
            recomendados = cursos_validos(cursos, aprobados_nombres, ciclo_actual, max_cursos)
            
            if recomendados:
                st.success("### üìã Cursos recomendados para el pr√≥ximo ciclo:")
                
                # Mostrar como tarjetas
                cols = st.columns(2)
                for i, curso in enumerate(recomendados):
                    with cols[i % 2]:
                        curso_info = next(c for c in cursos if c["nombre"] == curso)
                        st.markdown(f"""
                        <div class="course-card">
                            <strong>{curso_info['codigo']}</strong><br>
                            {curso}<br>
                            <small>A√±o: {curso_info['anio']} | Ciclo: {curso_info['ciclo']} | Cr√©ditos: {curso_info.get('creditos', 0)}</small>
                        </div>
                        """, unsafe_allow_html=True)
                
                # Mostrar tambi√©n como tabla
                df_recomendados = pd.DataFrame([{
                    "C√≥digo": c["codigo"],
                    "Nombre": c["nombre"],
                    "A√±o": c["anio"],
                    "Ciclo": c["ciclo"],
                    "Cr√©ditos": c.get("creditos", 0)
                } for c in cursos if c["nombre"] in recomendados])
                
                st.dataframe(df_recomendados, use_container_width=True, hide_index=True)
            else:
                st.warning("üòï No hay cursos v√°lidos disponibles para el pr√≥ximo ciclo con los requisitos actuales.")
        
        elif modo_recomendacion == "Simular varios ciclos":
            pass
        elif modo_recomendacion == "üß† Recomendaci√≥n por IA (CSP)":
            from csp_solver import planificar_ciclo_unico, planificar_toda_la_carrera
            st.info("Aplicando recomendaci√≥n basada en IA (CSP)...")

            if st.checkbox("üìò Simular toda la carrera con CSP"):
                plan = planificar_toda_la_carrera(cursos, aprobados_codigos, ciclo_actual, max_cursos)
                if plan:
                    for etapa in plan:
                        with st.expander(f"Ciclo {etapa['ciclo']}", expanded=False):
                            df = pd.DataFrame([{
                                "C√≥digo": c["codigo"],
                                "Nombre": c["nombre"],
                                "A√±o": c["anio"],
                                "Ciclo": c["ciclo"],
                                "Cr√©ditos": c.get("creditos", 0)
                            } for c in etapa["cursos"]])
                            st.dataframe(df, use_container_width=True, hide_index=True)
                else:
                    st.error("No se pudo encontrar una planificaci√≥n v√°lida con CSP.")
            else:
                cursos_ciclo = planificar_ciclo_unico(cursos, aprobados_codigos, ciclo_actual, max_cursos)
                if cursos_ciclo:
                    df = pd.DataFrame([{
                        "C√≥digo": c["codigo"],
                        "Nombre": c["nombre"],
                        "A√±o": c["anio"],
                        "Ciclo": c["ciclo"],
                        "Cr√©ditos": c.get("creditos", 0)
                    } for c in cursos_ciclo])
                    st.success("üìã Cursos recomendados para el pr√≥ximo ciclo (CSP):")
                    st.dataframe(df, use_container_width=True, hide_index=True)
                else:
                    st.warning("No hay cursos v√°lidos seg√∫n CSP para el pr√≥ximo ciclo.")

            with st.spinner("Simulando plan de estudios..."):
                plan = simular_avance(cursos, aprobados_nombres, ciclo_actual, max_cursos, n_ciclos=6)
            
            if plan:
                st.success("### üß≠ Plan de avance sugerido (6 ciclos):")
                
                for i, etapa in enumerate(plan):
                    with st.expander(f"üìå Ciclo {etapa['ciclo']} - A√±o {1 + (etapa['ciclo']-1)//2}", expanded=i<2):
                        if etapa["cursos"]:
                            # Mostrar m√©tricas r√°pidas
                            cols = st.columns(3)
                            with cols[0]:
                                st.metric("Cursos", len(etapa["cursos"]))
                            with cols[1]:
                                creditos = sum(c.get("creditos", 0) for c in cursos if c["nombre"] in etapa["cursos"])
                                st.metric("Total cr√©ditos", creditos)
                            with cols[2]:
                                dificultad = sum(len(c["requisitos"]) for c in cursos if c["nombre"] in etapa["cursos"])
                                st.metric("Dificultad relativa", dificultad)
                            
                            # Mostrar cursos como tarjetas
                            for curso in etapa["cursos"]:
                                curso_info = next(c for c in cursos if c["nombre"] == curso)
                                st.markdown(f"""
                                <div class="course-card">
                                    <strong>{curso_info['codigo']}</strong><br>
                                    {curso}<br>
                                    <small>A√±o: {curso_info['anio']} | Cr√©ditos: {curso_info.get('creditos', 0)}</small>
                                </div>
                                """, unsafe_allow_html=True)
                        else:
                            st.info("No hay cursos disponibles para este ciclo seg√∫n los requisitos.")
                
                # Mostrar alertas
                avisos = alertas_riesgo(plan, max_cursos)
                if avisos:
                    st.warning("### ‚ö†Ô∏è Alertas importantes:")
                    for aviso in avisos:
                        st.markdown(f"- {aviso}")
            else:
                st.error("No se pudo generar un plan de avance con los par√°metros actuales.")
# === P√ÅGINA DE VISUALIZACIONES ===
    st.markdown('<div class="header"><h1>üìä Visualizaciones del Avance Acad√©mico</h1></div>', unsafe_allow_html=True)
    
    # Verificar si hay cursos aprobados seleccionados
    if "seleccion_por_ciclo" not in st.session_state or not any(st.session_state["seleccion_por_ciclo"].values()):
        st.warning("Por favor selecciona tus cursos aprobados en la p√°gina de 'Mi Progreso' primero para habilitar las visualizaciones.")
        st.stop()
    
    # Obtener c√≥digos de cursos aprobados
    aprobados_codigos = []
    for key in st.session_state["seleccion_por_ciclo"]:
        if key.startswith("aprobado_"):
            anio_ciclo = key.replace("aprobado_", "").split("_")
            if len(anio_ciclo) == 2:
                anio = int(anio_ciclo[0])
                ciclo = int(anio_ciclo[1])
                for c in cursos_por_anio_ciclo.get(anio, {}).get(ciclo, []):
                    if c["nombre"] in st.session_state["seleccion_por_ciclo"][key]:
                        aprobados_codigos.append(c["codigo"])
    
    if not aprobados_codigos:
        st.warning("No hay cursos aprobados seleccionados. Por favor selecciona al menos un curso aprobado.")
        st.stop()
    
    # Gr√°ficos de progreso
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown("### üìà Progreso por a√±o")
        
        datos_progreso = []
        for anio in sorted(cursos_por_anio_ciclo):
            total_anio = sum(1 for c in cursos if c["anio"] == anio)
            aprobados_anio = sum(1 for c in cursos if c["anio"] == anio and c["codigo"] in aprobados_codigos)
            datos_progreso.append({
                "A√±o": f"A√±o {anio}",
                "Total": total_anio,
                "Aprobados": aprobados_anio,
                "Pendientes": total_anio - aprobados_anio
            })
        
        df_progreso = pd.DataFrame(datos_progreso).set_index("A√±o")
        st.bar_chart(df_progreso[["Aprobados", "Pendientes"]], color=["#2E86AB", "#F18F01"])
    
    with col2:
        st.markdown("### ‚è≥ Predicci√≥n de graduaci√≥n")
        
        # Obtener configuraci√≥n
        ciclo_actual = st.selectbox(
            "Ciclo acad√©mico pr√≥ximo", 
            [1, 2], 
            help="Selecciona el ciclo que vas a cursar",
            key="pred_ciclo"
        )
        max_cursos = st.slider(
            "Cursos por ciclo", 
            1, 6, 3,
            help="N√∫mero m√°ximo de cursos que planeas llevar por ciclo",
            key="pred_max"
        )
        
        if st.button("Calcular fecha estimada", key="btn_prediccion"):
            with st.spinner("Calculando..."):
                aprobados_nombres = [nombres_por_codigo[c] for c in aprobados_codigos if c in nombres_por_codigo]
                sem = predecir_graduacion(cursos, aprobados_nombres, ciclo_actual, max_cursos)
                
                if sem:
                    a√±o_graduacion = 2023 + (int(sem.split("-")[1]) // 2)
                    st.success(f"""
                    <div style="text-align: center; padding: 20px; background-color: #E8F4F8; border-radius: 10px;">
                        <h3>Semestre esperado de graduaci√≥n:</h3>
                        <h1 style="color: var(--primary);">{sem}</h1>
                        <p>Aproximadamente en {a√±o_graduacion}</p>
                    </div>
                    """, unsafe_allow_html=True)
                    
                    # Calcular tiempo estimado
                    ciclos_restantes = int(sem.split("-")[1]) - ciclo_actual
                    a√±os_restantes = ciclos_restantes // 2
                    meses_restantes = a√±os_restantes * 6  # 6 meses por ciclo
                    
                    st.metric("Tiempo estimado", f"{a√±os_restantes} a√±o(s) y {ciclos_restantes % 2} ciclo(s)")
                else:
                    st.error("No se puede completar el plan de estudios con la configuraci√≥n actual.")
    
    # Grafo de prerequisitos
    st.markdown("---")
    st.markdown('<div class="subheader"><h3>üìö Grafo de Prerequisitos</h3></div>', unsafe_allow_html=True)
    
    if st.button("üñáÔ∏è Generar grafo interactivo", use_container_width=True):
        with st.spinner("Generando visualizaci√≥n..."):
            G = construir_grafo(cursos)
            html_file = mostrar_grafo_pyvis(G, aprobados=aprobados_codigos)
            
            # Mostrar el grafo en un contenedor m√°s grande
            st.components.v1.html(open(html_file).read(), height=800, scrolling=True)
            
            st.info("""
            üí° **Leyenda del grafo:**
            - üîµ Nodos azules: Cursos aprobados
            - üü† Nodos naranja: Cursos pendientes
            - ‚û°Ô∏è Flechas: Relaciones de prerequisitos
            """)
    
    # Exportar datos
    st.markdown("---")
    st.markdown('<div class="subheader"><h3>üì§ Exportar datos</h3></div>', unsafe_allow_html=True)
    
    if st.button("üíæ Exportar mi progreso a JSON"):
        progreso = {
            "aprobados": aprobados_codigos,
            "configuracion": {
                "ciclo_actual": ciclo_actual,
                "max_cursos": max_cursos
            }
        }
        st.download_button(
            label="Descargar archivo JSON",
            data=json.dumps(progreso, indent=2),
            file_name="progreso_academico.json",
            mime="application/json"
        )